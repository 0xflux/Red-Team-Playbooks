# 7.1 Post Exploitation

| Name | Description | URL |
| --- | --- | --- |
| veil | https://github.com/Veil-Framework/Veil |
| Invoke-Obfuscation | https://github.com/danielbohannon/Invoke-Obfuscation |
| PSByPassCLM | https://github.com/padovah4ck/PSByPassCLM |

## Domain Enumeration

### Enumerate the domain name

```c
// CMD
C:\> echo %USERDNSDOMAIN%
C:\> systeminfo | findstr /B /C:"Domain"
C:\> wmic computersystem get domain

// PowerShell
PS C:\> Get-ADDomain
PS C:\> [System.Net.Dns]::GetHostByName(($env:computerName))
PS C:\> [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
```

### Enumerate domain forest trusts

```c
// CMD
C:\> nltest /trusted_domains
C:\> nltest /server:cdc001.corp.contoso.local /sc_query:contoso.local

// PowerShell
PS C:\> ([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()
PS C:\> ([System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest())
PS C:\> ([ADSISearcher]"(objectClass=trustedDomain)").FindAll()
PS C:\> ([ADSISearcher]"(objectClass=trustedDomain)").FindAll() | %{$a=$_.Properties["trustattributes"]; $d=$_.Properties["trustdirection"]; $t=$_.Properties["trusttype"] ; write-Host $_.Properties["distinguishedname"] $a $d $t}
```

### Get information about the password policy

```c
// CMD
C:\> net accounts
C:\> net accounts /domain

// PowerShell
PS C:\> Get-ADDefaultDomainPasswordPolicy -Current LoggedOnUser
```

## Computer Enumeration

### Enumerate all domain computers

```c
// CMD
C:\> net group "Domain Computers" /domain

// PowerShell
PS C:\> ([ADSISearcher]"ObjectClass=computer").FindAll()
```

### Enumerate specific domain computers

```c
// PowerShell
PS C:\> ([ADSISearcher]"(&(objectClass=computer)(name=DC*))").FindAll()
PS C:\> ([ADSISearcher]"(&(objectClass=computer)(name=FIL01))").FindAll()
```

### Enumerate all domain controllers

```c
// CMD
C:\> nltest /dclist:corp.contoso.local
C:\> nslookup -type=all _ldap._tcp.dc._msdcs.corp.contoso.local
C:\> net group "domain controllers" /domain

// PowerShell
PS C:\> ([ADSISearcher]"(&(objectCategory=computer)(userAccountControl:1.2.840.113556.1.4.803:=8192))").FindAll()
```

### Enumerate domain controllers which authenticated the current session

```c
// CMD
C:\>echo %LOGONSERVER%
C:\> nltest /dsgetdc:corp.contoso.local
```

## User Enumeration

### Enumerate a single user

```c
// CMD
C:\> net user maurice.moss /domain

// PowerShell
PS C:\> ([ADSISearcher]"(&(objectClass=user)(samAccountType=805306368)(samaccountname=maurice.moss))").FindAll().Properties
```

### Enumerate all domain users

```c
// CMD
C:\> net user /domain

// PowerShell
PS C:\> ([ADSISearcher]"(&(objectClass=user)(samAccountType=805306368))").FindAll()|ft
```

### Enumerate all users with specific properties

```c
// PowerShell
PS C:\> ([ADSISearcher]"(&(objectClass=user)(samAccountType=805306368))").FindAll() | %{ $_.Properties["samaccountname"] }
```

### Enumerate all members of a specific domain group

```c
// CMD
C:\> net group "Domain Admins" /domain

// PowerShell
PS C:\> ([ADSISearcher]"(&(ObjectClass=group)(samaccountname=Domain Admins))").FindOne()
PS C:\> ([ADSISearcher]"(distinguishedname=CN=TS ACCESS,CN=Users,DC=corp,DC=contoso,DC=local)").FindOne().Properties.member
```

### Enumerate all groups with the string "ACCESS" in the name property

```c
//PowerShell
PS C:\> ([ADSISearcher]"(&(objectClass=group)(name=*ACCESS*))").FindAll()
```

### Enumerate all users with a set Service Principal name (SPN)

```c
// PowerShell
PS C:\> ([ADSISearcher]"(&(objectClass=user)(servicePrincipalName=*)(samAccountType=805306368))").FindAll()
```

## Enumerating Groups

### Enumerat all domain groups

```c
// CMD
C:\> net group /domain

// PowerShell
PS C:\> ([ADSISearcher]"ObjectClass=group").FindAll()
PS C:\> ([ADSISearcher]"ObjectClass=group").FindAll() | %{ $_.Properties["samaccountname"] }
```

## AppLocker Enumeration

```c
// CMD
C:\> reg query HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\SrpV2\Exe\

// PowerShell
PS C:\> (Get-AppLockerPolicy -Local).RuleCollections
PS C:\> Get-AppLockerPolicy -Effective -Xml
PS C:\> Get-ChildItem -Path HKLM:Software\Policies\Microsoft\Windows\SrpV2 -Recurse
PS C:\> Get-AppLockerPolicy -Domain -LDAP "LDAP:// DC13.Contoso.com/CN={31B2F340-016D-11D2-945F-00C04FB984F9},CN=Policies,CN=System,DC=Contoso,DC=com
```

## Enable RDP

```c
C:\> reg add "HKEY LOCAL t1ACHINE\SYSTEH\CurentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f

// Tunnel RDP through TCP/443
C:\> reg add "HKLM\System\CurrentControlSet\Control\TerminalServer\WinStations\RDP-Tcp" /v PortNumber /t REG_DWORD /d 443 /f
```

## Spoofing Office Macro
```c
URL: https://github.com/christophetd/spoofing-office-macro
```

## Windows Advanced Threat Protection (ATP)

### Information

Process:
- MsSense.exe

Service:
- Display name: Windows Defender Advanced Threat Protection Service

Name:
- Sense

Registry:
- HKLM\SOFTWARE\Policies\Microsoft\Windows Advanced Threat Protection

File Paths:
- C:\Program Files\Windows Defender Advanced Threat Protection\

### Check Registry

```c
C:\> reg query HKLM\SOFTWARE\Policies\Microsoft\Windows Advanced Threat Protection /s
```

### Check Service

```c
C:\> sc query sense
PS C:\> Get-Service Sense
```

### Process

```c
C:\> tasklist | findstr /i mssense.exe
```

### Previous

- [7 Actions-on-Objective](https://github.com/0xsyr0/Red-Team-Playbooks/blob/master/7-Actions-on-Objective/7-Actions-on-Objective.md)

### Next

- [7.2 Exfiltration](https://github.com/0xsyr0/Red-Team-Playbooks/blob/master/7-Actions-on-Objective/7.2-Exfiltration.md)
